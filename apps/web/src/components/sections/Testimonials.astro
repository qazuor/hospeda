---
import type { TestimonialType } from '@/data/db/home';

// Generate stars based on rating
const generateStars = (rating: number) => {
    return Array.from({ length: 5 }, (_, i) => i < Math.floor(rating));
};

// Generate initials from name
const getInitials = (name: string) => {
    return name
        .split(' ')
        .map(word => word.charAt(0))
        .join('')
        .toUpperCase()
        .slice(0, 2);
};

interface Props {
    testimonials: TestimonialType[];
    title: string;
    subtitle?: string;
}

const { testimonials, title, subtitle } = Astro.props;
---

<section class='py-16 bg-white dark:bg-gray-900'>
    <div class='container mx-auto px-4'>
        <div class='text-center mb-12'>
            <h2 class='text-3xl font-bold mb-4 text-gray-900 dark:text-white'>{title}</h2>
            <p class='text-gray-600 dark:text-gray-400 max-w-2xl mx-auto'>
                {subtitle}
            </p>
        </div>

        {
            testimonials.length > 0 ? (
                <div class='relative max-w-6xl mx-auto'>
                    <!-- Testimonials Carousel -->
                    <div id='testimonials-carousel' class='overflow-hidden rounded-2xl'>
                        <div id='testimonials-track' class='flex transition-transform duration-500 ease-in-out'>
                            {testimonials.map((testimonial, index) => (
                                <div class='w-full flex-shrink-0 px-4'>
                                    <div class='bg-gradient-to-br from-gray-50 to-white dark:from-gray-800 dark:to-gray-700 p-8 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-600 max-w-4xl mx-auto'>
                                        <!-- Quote Icon -->
                                        <div class='flex justify-center mb-6'>
                                            <div class='w-12 h-12 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full flex items-center justify-center'>
                                                <svg class='w-6 h-6 text-white' fill='currentColor' viewBox='0 0 24 24'>
                                                    <path d='M14.017 21v-7.391c0-5.704 3.731-9.57 8.983-10.609l.995 2.151c-2.432.917-3.995 3.638-3.995 5.849h4v10h-9.983zm-14.017 0v-7.391c0-5.704 3.748-9.57 9-10.609l.996 2.151c-2.433.917-3.996 3.638-3.996 5.849h4v10h-10z'/>
                                                </svg>
                                            </div>
                                        </div>

                                        <!-- Review Text -->
                                        <blockquote class='text-center mb-8'>
                                            <p class='text-lg md:text-xl text-gray-700 dark:text-gray-300 leading-relaxed italic'>
                                                "{testimonial.comment}"
                                            </p>
                                        </blockquote>

                                        <!-- Rating -->
                                        <div class='flex justify-center mb-6'>
                                            <div class='flex space-x-1'>
                                                {generateStars(testimonial.rating).map((filled, starIndex) => (
                                                    <svg
                                                        key={starIndex}
                                                        class={`w-5 h-5 ${filled ? 'text-yellow-400' : 'text-gray-300 dark:text-gray-600'}`}
                                                        fill='currentColor'
                                                        viewBox='0 0 20 20'
                                                    >
                                                        <path d='M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z' />
                                                    </svg>
                                                ))}
                                            </div>
                                        </div>

                                        <!-- Author Info -->
                                        <div class='flex items-center justify-center space-x-4'>
                                            <div class='w-16 h-16 rounded-full bg-gradient-to-r from-primary-500 to-secondary-500 flex items-center justify-center shadow-lg'>
                                                <span class='text-white font-bold text-lg'>
                                                    {getInitials(testimonial.authorName)}
                                                </span>
                                            </div>
                                            <div class='text-center'>
                                                <h4 class='font-semibold text-gray-900 dark:text-white text-lg'>
                                                    {testimonial.authorName}
                                                </h4>
                                                <p class='text-gray-600 dark:text-gray-400 text-sm'>
                                                    {testimonial.authorLocation || 'Argentina'}
                                                </p>
                                                <div class='flex items-center justify-center mt-2 text-sm text-gray-500 dark:text-gray-400'>
                                                    <span class='mr-1'>
                                                        {testimonial.relatedType === 'accommodation' ? 'üè®' : 'üìç'}
                                                    </span>
                                                    <span class='font-medium'>{testimonial.relatedName}</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <!-- Navigation Buttons -->
                    <button 
                        id='prev-btn'
                        class='absolute left-0 top-1/2 -translate-y-1/2 -translate-x-4 w-12 h-12 bg-white dark:bg-gray-800 rounded-full shadow-lg border border-gray-200 dark:border-gray-600 flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 hover:scale-105'
                        aria-label='Testimonio anterior'
                    >
                        <svg class='w-5 h-5' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                            <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M15 19l-7-7 7-7'/>
                        </svg>
                    </button>

                    <button 
                        id='next-btn'
                        class='absolute right-0 top-1/2 -translate-y-1/2 translate-x-4 w-12 h-12 bg-white dark:bg-gray-800 rounded-full shadow-lg border border-gray-200 dark:border-gray-600 flex items-center justify-center text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-all duration-200 hover:scale-105'
                        aria-label='Siguiente testimonio'
                    >
                        <svg class='w-5 h-5' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                            <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M9 5l7 7-7 7'/>
                        </svg>
                    </button>

                    <!-- Dots Indicator -->
                    <div class='flex justify-center mt-8 space-x-2'>
                        {testimonials.map((_, index) => (
                            <button 
                                class={`w-3 h-3 rounded-full transition-all duration-200 testimonial-dot ${index === 0 ? 'bg-primary-500 scale-125' : 'bg-gray-300 dark:bg-gray-600 hover:bg-gray-400 dark:hover:bg-gray-500'}`}
                                data-index={index}
                                aria-label={`Ir al testimonio ${index + 1}`}
                            />
                        ))}
                    </div>
                </div>
            ) : (
                <div class='text-center py-12'>
                    <div class='bg-gradient-to-br from-gray-50 to-white dark:from-gray-800 dark:to-gray-700 p-12 rounded-2xl shadow-lg border border-gray-100 dark:border-gray-600 max-w-md mx-auto'>
                        <div class='w-16 h-16 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full flex items-center justify-center mx-auto mb-6'>
                            <svg class='w-8 h-8 text-white' fill='currentColor' viewBox='0 0 24 24'>
                                <path d='M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z'/>
                            </svg>
                        </div>
                        <h3 class='text-xl font-semibold mb-3 text-gray-900 dark:text-gray-100'>
                            ¬°S√© el primero en compartir tu experiencia!
                        </h3>
                        <p class='text-gray-600 dark:text-gray-400'>
                            Ayuda a otros viajeros compartiendo tu opini√≥n sobre nuestros alojamientos y destinos.
                        </p>
                    </div>
                </div>
            )
        }
    </div>
</section>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const track = document.getElementById('testimonials-track');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const dots = document.querySelectorAll('.testimonial-dot');
        
        if (!track || !prevBtn || !nextBtn) return;
        
        let currentIndex = 0;
        const totalSlides = dots.length;
        
        // Auto-play interval (optional)
        let autoPlayInterval;
        
        function updateCarousel() {
            const translateX = -currentIndex * 100;
            track.style.transform = `translateX(${translateX}%)`;
            
            // Update dots
            dots.forEach((dot, index) => {
                if (index === currentIndex) {
                    dot.classList.remove('bg-gray-300', 'dark:bg-gray-600');
                    dot.classList.add('bg-primary-500', 'scale-125');
                } else {
                    dot.classList.remove('bg-primary-500', 'scale-125');
                    dot.classList.add('bg-gray-300', 'dark:bg-gray-600');
                }
            });
        }
        
        function nextSlide() {
            currentIndex = (currentIndex + 1) % totalSlides;
            updateCarousel();
        }
        
        function prevSlide() {
            currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
            updateCarousel();
        }
        
        function goToSlide(index) {
            currentIndex = index;
            updateCarousel();
        }
        
        // Event listeners
        nextBtn.addEventListener('click', nextSlide);
        prevBtn.addEventListener('click', prevSlide);
        
        // Dot navigation
        dots.forEach((dot, index) => {
            dot.addEventListener('click', () => goToSlide(index));
        });
        
        // Auto-play (uncomment to enable)
        function startAutoPlay() {
            autoPlayInterval = setInterval(nextSlide, 5000); // Change slide every 5 seconds
        }
        
        function stopAutoPlay() {
            if (autoPlayInterval) {
                clearInterval(autoPlayInterval);
            }
        }
        
        // Start auto-play if there are multiple testimonials
        if (totalSlides > 1) {
            startAutoPlay();
            
            // Pause auto-play on hover
            const carousel = document.getElementById('testimonials-carousel');
            if (carousel) {
                carousel.addEventListener('mouseenter', stopAutoPlay);
                carousel.addEventListener('mouseleave', startAutoPlay);
            }
        }
        
        // Hide navigation if only one testimonial
        if (totalSlides <= 1) {
            prevBtn.style.display = 'none';
            nextBtn.style.display = 'none';
            dots.forEach(dot => dot.style.display = 'none');
        }
    });
</script>
