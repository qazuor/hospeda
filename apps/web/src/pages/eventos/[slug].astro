---
export const prerender = true;

import { getAllEvents, getEventBySlug } from '@/data/db/events';
import MainLayout from '@/layout/MainLayout.astro';
import { getEventsIndexUrl } from '@/utils/urls';

export async function getStaticPaths() {
    const events = await getAllEvents();
    return events.map((event) => ({
        params: { slug: event.slug },
    }));
}

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect(getEventsIndexUrl());
}

const { event } = await getEventBySlug({
    locals: Astro.locals,
    slug,
});

if (!event) {
    return Astro.redirect('/eventos');
}

const title = `${event.name} - Evento`;
const description = event.description || `Únete a ${event.name}, un evento increíble que no te puedes perder.`;

// Helper functions for date formatting
const formatDate = (date: Date | string) => {
    const d = new Date(date);
    return d.toLocaleDateString('es-ES', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric',
    });
};

const formatTime = (date: Date | string) => {
    const d = new Date(date);
    return d.toLocaleTimeString('es-ES', {
        hour: '2-digit',
        minute: '2-digit',
    });
};

const formatDateTime = (date: Date | string) => {
    return `${formatDate(date)} a las ${formatTime(date)}`;
};
---

<MainLayout title={title} description={description}>
    <div class='min-h-screen bg-white dark:bg-gray-900 transition-colors duration-200'>
        <!-- Hero Section -->
        <section class='relative h-96 md:h-[500px] overflow-hidden'>
            {
                event.media && event.media?.featuredImage ? (
                    <img src={event.media?.featuredImage.url} alt={event.name} class='w-full h-full object-cover' />
                ) : (
                    <div class='w-full h-full bg-gradient-to-br from-purple-400 to-pink-500' />
                )
            }
            <div class='absolute inset-0 bg-black bg-opacity-40'></div>
            <div class='absolute inset-0 flex items-center justify-center'>
                <div class='text-center text-white max-w-4xl mx-auto px-4'>
                    <div class='mb-4'>
                        <span class='inline-block bg-purple-600 text-white px-3 py-1 rounded-full text-sm font-medium'>
                            {event.category || 'Evento'}
                        </span>
                    </div>
                    <h1 class='text-4xl md:text-6xl font-bold mb-4'>{event.name}</h1>
                    {
                        event.date.start && (
                            <p class='text-xl md:text-2xl text-gray-200'>{formatDateTime(event.date.start)}</p>
                        )
                    }
                </div>
            </div>
        </section>

        <!-- Breadcrumb -->
        <nav class='bg-gray-50 dark:bg-gray-800 py-4 border-b border-gray-200 dark:border-gray-700'>
            <div class='container mx-auto px-4'>
                <ol class='flex items-center space-x-2 text-sm'>
                    <li>
                        <a
                            href='/'
                            class='text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300'
                            >Inicio</a
                        >
                    </li>
                    <li class='text-gray-500 dark:text-gray-400'>/</li>
                    <li>
                        <a
                            href={getEventsIndexUrl()}
                            class='text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300'
                            >Eventos</a
                        >
                    </li>
                    <li class='text-gray-500 dark:text-gray-400'>/</li>
                    <li class='text-gray-900 dark:text-white font-medium'>{event.name}</li>
                </ol>
            </div>
        </nav>

        <!-- Content -->
        <div class='container mx-auto px-4 py-12'>
            <div class='grid grid-cols-1 lg:grid-cols-3 gap-12'>
                <!-- Main Content -->
                <div class='lg:col-span-2'>
                    <!-- Description -->
                    <section class='mb-12'>
                        <h2 class='text-2xl font-bold text-gray-900 dark:text-white mb-6'>Sobre este evento</h2>
                        <div class='prose prose-lg dark:prose-invert max-w-none'>
                            <p class='text-gray-700 dark:text-gray-300 leading-relaxed'>
                                {
                                    event.description ||
                                        `${event.name} es un evento increíble que promete ser una experiencia única e inolvidable. 
                                Únete a nosotros para disfrutar de momentos especiales, conocer gente nueva y vivir experiencias que recordarás para siempre.`
                                }
                            </p>
                        </div>
                    </section>

                    <!-- Event Details -->
                    <section class='mb-12'>
                        <h2 class='text-2xl font-bold text-gray-900 dark:text-white mb-6'>Detalles del evento</h2>
                        <div class='bg-gray-50 dark:bg-gray-800 rounded-lg p-6'>
                            <div class='grid grid-cols-1 md:grid-cols-2 gap-6'>
                                {
                                    event.date?.start && (
                                        <div class='flex items-start'>
                                            <svg
                                                class='w-6 h-6 text-purple-600 dark:text-purple-400 mr-3 mt-1'
                                                fill='none'
                                                stroke='currentColor'
                                                viewBox='0 0 24 24'
                                            >
                                                <path
                                                    stroke-linecap='round'
                                                    stroke-linejoin='round'
                                                    stroke-width='2'
                                                    d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'
                                                />
                                            </svg>
                                            <div>
                                                <h3 class='font-semibold text-gray-900 dark:text-white mb-1'>
                                                    Fecha y hora
                                                </h3>
                                                <p class='text-gray-600 dark:text-gray-400'>
                                                    {formatDateTime(event.date?.start)}
                                                </p>
                                                {event.date.end && (
                                                    <p class='text-gray-600 dark:text-gray-400 text-sm mt-1'>
                                                        Hasta: {formatDateTime(event.date.end)}
                                                    </p>
                                                )}
                                            </div>
                                        </div>
                                    )
                                }

                                {
                                    event.location && (
                                        <div class='flex items-start'>
                                            <svg
                                                class='w-6 h-6 text-purple-600 dark:text-purple-400 mr-3 mt-1'
                                                fill='none'
                                                stroke='currentColor'
                                                viewBox='0 0 24 24'
                                            >
                                                <path
                                                    stroke-linecap='round'
                                                    stroke-linejoin='round'
                                                    stroke-width='2'
                                                    d='M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z'
                                                />
                                            </svg>
                                            <div>
                                                <h3 class='font-semibold text-gray-900 dark:text-white mb-1'>
                                                    Ubicación
                                                </h3>
                                                <p class='text-gray-600 dark:text-gray-400'>{event.location}</p>
                                            </div>
                                        </div>
                                    )
                                }

                                {
                                    event.organizer && (
                                        <div class='flex items-start'>
                                            <svg
                                                class='w-6 h-6 text-purple-600 dark:text-purple-400 mr-3 mt-1'
                                                fill='none'
                                                stroke='currentColor'
                                                viewBox='0 0 24 24'
                                            >
                                                <path
                                                    stroke-linecap='round'
                                                    stroke-linejoin='round'
                                                    stroke-width='2'
                                                    d='M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z'
                                                />
                                            </svg>
                                            <div>
                                                <h3 class='font-semibold text-gray-900 dark:text-white mb-1'>
                                                    Organizador
                                                </h3>
                                                <p class='text-gray-600 dark:text-gray-400'>{event.organizer}</p>
                                            </div>
                                        </div>
                                    )
                                }
                            </div>
                        </div>
                    </section>

                    <!-- Image Gallery -->
                    {
                        event.media && event.media?.gallery && event.media?.gallery.length > 1 && (
                            <section class='mb-12'>
                                <h2 class='text-2xl font-bold text-gray-900 dark:text-white mb-6'>Galería</h2>
                                <div class='grid grid-cols-2 md:grid-cols-3 gap-4'>
                                    {event.media.gallery.map((image, index) => (
                                        <div class='aspect-square overflow-hidden rounded-lg'>
                                            <img
                                                src={image.url}
                                                alt={`${event.name} - Imagen ${index + 2}`}
                                                class='w-full h-full object-cover hover:scale-105 transition-transform duration-300'
                                                loading='lazy'
                                            />
                                        </div>
                                    ))}
                                </div>
                            </section>
                        )
                    }
                </div>

                <!-- Sidebar -->
                <div class='lg:col-span-1'>
                    <!-- Pricing & Registration -->
                    <div
                        class='bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700'
                    >
                        <div class='text-center mb-6'>
                            {
                                event.pricing?.price !== undefined ? (
                                    <div class='text-3xl font-bold text-purple-600 dark:text-purple-400'>
                                        {event.pricing?.price === 0
                                            ? 'Gratis'
                                            : `$${event.pricing?.price.toLocaleString()}`}
                                    </div>
                                ) : (
                                    <div class='text-lg text-gray-600 dark:text-gray-400'>Consultar precio</div>
                                )
                            }
                            <p class='text-gray-600 dark:text-gray-400 text-sm mt-1'>por persona</p>
                        </div>

                        <button
                            class='w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-3 px-4 rounded-lg transition-colors mb-4'
                        >
                            Registrarse al evento
                        </button>

                        <div class='text-center'>
                            <button
                                class='text-purple-600 dark:text-purple-400 hover:text-purple-700 dark:hover:text-purple-300 text-sm font-medium'
                            >
                                Compartir evento
                            </button>
                        </div>
                    </div>

                    <!-- Quick Info -->
                    <div
                        class='bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700'
                    >
                        <h3 class='text-lg font-semibold text-gray-900 dark:text-white mb-4'>Información importante</h3>
                        <div class='space-y-3 text-sm'>
                            <div class='flex items-center text-gray-600 dark:text-gray-400'>
                                <svg class='w-4 h-4 mr-2' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                    <path
                                        stroke-linecap='round'
                                        stroke-linejoin='round'
                                        stroke-width='2'
                                        d='M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z'></path>
                                </svg>
                                Confirmación inmediata
                            </div>
                            <div class='flex items-center text-gray-600 dark:text-gray-400'>
                                <svg class='w-4 h-4 mr-2' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                    <path
                                        stroke-linecap='round'
                                        stroke-linejoin='round'
                                        stroke-width='2'
                                        d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z'></path>
                                </svg>
                                Cancelación gratuita
                            </div>
                            <div class='flex items-center text-gray-600 dark:text-gray-400'>
                                <svg class='w-4 h-4 mr-2' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                    <path
                                        stroke-linecap='round'
                                        stroke-linejoin='round'
                                        stroke-width='2'
                                        d='M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z'
                                    ></path>
                                </svg>
                                Soporte 24/7
                            </div>
                        </div>
                    </div>

                    <!-- Related Events -->
                    <div class='bg-gradient-to-br from-purple-500 to-pink-600 rounded-lg p-6 text-white'>
                        <h3 class='text-lg font-semibold mb-3'>¿Te interesa?</h3>
                        <p class='text-purple-100 mb-4'>Descubre más eventos increíbles.</p>
                        <a
                            href={getEventsIndexUrl()}
                            class='block w-full bg-white text-purple-600 text-center py-3 px-4 rounded-lg font-semibold hover:bg-gray-100 transition-colors'
                        >
                            Ver más eventos
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</MainLayout>
