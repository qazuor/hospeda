---
export const prerender = true;

import { getAllPosts, getPostBySlug } from '@/data/db/posts';
import MainLayout from '@/layout/MainLayout.astro';
import { getBlogIndexUrl } from '@/utils/urls';

export async function getStaticPaths() {
    const posts = await getAllPosts();
    return posts.map((post) => ({
        params: { slug: post.slug },
    }));
}

const { slug } = Astro.params;

if (!slug) {
    return Astro.redirect(getBlogIndexUrl());
}

const { post } = await getPostBySlug({
    locals: Astro.locals,
    slug,
});

if (!post) {
    return Astro.redirect('/publicaciones');
}

const title = `${post.title} - Blog`;
const description = post.summary || `Lee ${post.title}, un artículo interesante en nuestro blog.`;

// Helper functions
const formatDate = (date: Date | string) => {
    const d = new Date(date);
    return d.toLocaleDateString('es-ES', {
        weekday: 'long',
        day: 'numeric',
        month: 'long',
        year: 'numeric',
    });
};

const getReadingTime = (content: string) => {
    const wordsPerMinute = 200;
    const wordCount = content.split(' ').length;
    const readingTime = Math.ceil(wordCount / wordsPerMinute);
    return readingTime;
};
---

<MainLayout title={title} description={description}>
    <div class='min-h-screen bg-white dark:bg-gray-900 transition-colors duration-200'>
        <!-- Hero Section -->
        <section class='relative py-16 bg-gray-50 dark:bg-gray-800'>
            <div class='container mx-auto px-4'>
                <div class='max-w-4xl mx-auto text-center'>
                    <div class='mb-6'>
                        <span class='inline-block bg-emerald-600 text-white px-3 py-1 rounded-full text-sm font-medium'>
                            {post.category || 'Artículo'}
                        </span>
                    </div>
                    <h1 class='text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-6'>
                        {post.title}
                    </h1>
                    <div class='flex items-center justify-center space-x-6 text-gray-600 dark:text-gray-400'>
                        <div class='flex items-center'>
                            <svg class='w-5 h-5 mr-2' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                <path
                                    stroke-linecap='round'
                                    stroke-linejoin='round'
                                    stroke-width='2'
                                    d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'
                                ></path>
                            </svg>
                            {formatDate(post.updatedAt || post.createdAt)}
                        </div>
                        {
                            post.authorId && (
                                <div class='flex items-center'>
                                    <svg class='w-5 h-5 mr-2' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                        <path
                                            stroke-linecap='round'
                                            stroke-linejoin='round'
                                            stroke-width='2'
                                            d='M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z'
                                        />
                                    </svg>
                                    {post.authorId}
                                </div>
                            )
                        }
                        {
                            post.content && (
                                <div class='flex items-center'>
                                    <svg class='w-5 h-5 mr-2' fill='none' stroke='currentColor' viewBox='0 0 24 24'>
                                        <path
                                            stroke-linecap='round'
                                            stroke-linejoin='round'
                                            stroke-width='2'
                                            d='M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z'
                                        />
                                    </svg>
                                    {getReadingTime(post.content)} min lectura
                                </div>
                            )
                        }
                    </div>
                </div>
            </div>
        </section>

        <!-- Breadcrumb -->
        <nav class='bg-white dark:bg-gray-900 py-4 border-b border-gray-200 dark:border-gray-700'>
            <div class='container mx-auto px-4'>
                <ol class='flex items-center space-x-2 text-sm'>
                    <li>
                        <a
                            href='/'
                            class='text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300'
                            >Inicio</a
                        >
                    </li>
                    <li class='text-gray-500 dark:text-gray-400'>/</li>
                    <li>
                        <a
                            href={getBlogIndexUrl()}
                            class='text-emerald-600 dark:text-emerald-400 hover:text-emerald-700 dark:hover:text-emerald-300'
                            >Publicaciones</a
                        >
                    </li>
                    <li class='text-gray-500 dark:text-gray-400'>/</li>
                    <li class='text-gray-900 dark:text-white font-medium'>{post.title}</li>
                </ol>
            </div>
        </nav>

        <!-- Content -->
        <div class='container mx-auto px-4 py-12'>
            <div class='grid grid-cols-1 lg:grid-cols-4 gap-12'>
                <!-- Main Content -->
                <div class='lg:col-span-3'>
                    <!-- Featured Image -->
                    {
                        post.media?.featuredImage && (
                            <div class='mb-8'>
                                <img
                                    src={post.media.featuredImage.url}
                                    alt={post.title}
                                    class='w-full h-64 md:h-96 object-cover rounded-lg'
                                />
                            </div>
                        )
                    }

                    <!-- Excerpt -->
                    {
                        post.summary && (
                            <div class='mb-8 p-6 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg border-l-4 border-emerald-600'>
                                <p class='text-lg text-gray-700 dark:text-gray-300 italic'>{post.summary}</p>
                            </div>
                        )
                    }

                    <!-- Content -->
                    <article class='prose prose-lg dark:prose-invert max-w-none'>
                        {
                            post.content ? (
                                <div set:html={post.content} />
                            ) : (
                                <div>
                                    <p class='text-gray-700 dark:text-gray-300 leading-relaxed mb-6'>
                                        Este es un artículo fascinante que explora diferentes aspectos del tema que nos
                                        ocupa. A través de una narrativa envolvente y datos bien documentados,
                                        descubriremos juntos las múltiples facetas de esta historia.
                                    </p>

                                    <h2 class='text-2xl font-bold text-gray-900 dark:text-white mb-4'>Introducción</h2>
                                    <p class='text-gray-700 dark:text-gray-300 leading-relaxed mb-6'>
                                        En el mundo actual, es fundamental entender los matices y complejidades que
                                        rodean este tema. A lo largo de este artículo, exploraremos diferentes
                                        perspectivas y proporcionaremos información valiosa que te ayudará a comprender
                                        mejor el contexto.
                                    </p>

                                    <h2 class='text-2xl font-bold text-gray-900 dark:text-white mb-4'>Desarrollo</h2>
                                    <p class='text-gray-700 dark:text-gray-300 leading-relaxed mb-6'>
                                        Los expertos coinciden en que este es un tema de gran relevancia en la
                                        actualidad. Las investigaciones más recientes han demostrado que existe una
                                        correlación directa entre varios factores que influyen en el resultado final.
                                    </p>

                                    <blockquote class='border-l-4 border-emerald-600 pl-6 py-4 my-6 bg-gray-50 dark:bg-gray-800 rounded-r-lg'>
                                        <p class='text-gray-700 dark:text-gray-300 italic'>
                                            "La comprensión profunda de estos conceptos es esencial para cualquier
                                            persona que desee mantenerse actualizada en este campo en constante
                                            evolución."
                                        </p>
                                    </blockquote>

                                    <h2 class='text-2xl font-bold text-gray-900 dark:text-white mb-4'>Conclusión</h2>
                                    <p class='text-gray-700 dark:text-gray-300 leading-relaxed mb-6'>
                                        En resumen, hemos explorado los aspectos más importantes de este tema
                                        fascinante. Esperamos que esta información te haya resultado útil y te invite a
                                        seguir profundizando en el conocimiento de este campo.
                                    </p>
                                </div>
                            )
                        }
                    </article>

                    <!-- Tags -->
                    {
                        post.tags && post.tags.length > 0 && (
                            <div class='mt-8 pt-8 border-t border-gray-200 dark:border-gray-700'>
                                <h3 class='text-lg font-semibold text-gray-900 dark:text-white mb-4'>Etiquetas</h3>
                                <div class='flex flex-wrap gap-2'>
                                    {post.tags.map((tag) => (
                                        <span class='px-3 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-300 text-sm rounded-full'>
                                            #{tag}
                                        </span>
                                    ))}
                                </div>
                            </div>
                        )
                    }

                    <!-- Share -->
                    <div class='mt-8 pt-8 border-t border-gray-200 dark:border-gray-700'>
                        <h3 class='text-lg font-semibold text-gray-900 dark:text-white mb-4'>Compartir artículo</h3>
                        <div class='flex space-x-4'>
                            <button
                                class='flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors'
                            >
                                <svg class='w-4 h-4 mr-2' fill='currentColor' viewBox='0 0 24 24'>
                                    <path
                                        d='M24 4.557c-.883.392-1.832.656-2.828.775 1.017-.609 1.798-1.574 2.165-2.724-.951.564-2.005.974-3.127 1.195-.897-.957-2.178-1.555-3.594-1.555-3.179 0-5.515 2.966-4.797 6.045-4.091-.205-7.719-2.165-10.148-5.144-1.29 2.213-.669 5.108 1.523 6.574-.806-.026-1.566-.247-2.229-.616-.054 2.281 1.581 4.415 3.949 4.89-.693.188-1.452.232-2.224.084.626 1.956 2.444 3.379 4.6 3.419-2.07 1.623-4.678 2.348-7.29 2.04 2.179 1.397 4.768 2.212 7.548 2.212 9.142 0 14.307-7.721 13.995-14.646.962-.695 1.797-1.562 2.457-2.549z'
                                    ></path>
                                </svg>
                                Twitter
                            </button>
                            <button
                                class='flex items-center px-4 py-2 bg-blue-800 text-white rounded-lg hover:bg-blue-900 transition-colors'
                            >
                                <svg class='w-4 h-4 mr-2' fill='currentColor' viewBox='0 0 24 24'>
                                    <path
                                        d='M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z'
                                    ></path>
                                </svg>
                                Facebook
                            </button>
                            <button
                                class='flex items-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors'
                            >
                                <svg class='w-4 h-4 mr-2' fill='currentColor' viewBox='0 0 24 24'>
                                    <path
                                        d='M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488'
                                    ></path>
                                </svg>
                                WhatsApp
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class='lg:col-span-1'>
                    <!-- Author Info -->
                    {
                        post.authorId && (
                            <div class='bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700'>
                                <h3 class='text-lg font-semibold text-gray-900 dark:text-white mb-4'>Sobre el autor</h3>
                                <div class='flex items-center mb-4'>
                                    <div class='w-12 h-12 bg-emerald-600 rounded-full flex items-center justify-center text-white font-semibold'>
                                        {post.authorId.charAt(0).toUpperCase()}
                                    </div>
                                    <div class='ml-3'>
                                        <h4 class='font-semibold text-gray-900 dark:text-white'>{post.authorId}</h4>
                                        <p class='text-sm text-gray-600 dark:text-gray-400'>Escritor</p>
                                    </div>
                                </div>
                                <p class='text-sm text-gray-600 dark:text-gray-400'>
                                    Apasionado por compartir experiencias y conocimientos sobre viajes y turismo.
                                </p>
                            </div>
                        )
                    }

                    <!-- Related Posts -->
                    <div
                        class='bg-white dark:bg-gray-800 rounded-lg shadow-md p-6 mb-8 border border-gray-200 dark:border-gray-700'
                    >
                        <h3 class='text-lg font-semibold text-gray-900 dark:text-white mb-4'>Artículos relacionados</h3>
                        <div class='space-y-4'>
                            <article
                                class='border-b border-gray-200 dark:border-gray-700 pb-4 last:border-b-0 last:pb-0'
                            >
                                <h4 class='font-medium text-gray-900 dark:text-white mb-2 line-clamp-2'>
                                    <a
                                        href={getBlogIndexUrl()}
                                        class='hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors'
                                    >
                                        Guía completa para planificar tu próximo viaje
                                    </a>
                                </h4>
                                <p class='text-sm text-gray-600 dark:text-gray-400'>15 de enero, 2024</p>
                            </article>
                            <article
                                class='border-b border-gray-200 dark:border-gray-700 pb-4 last:border-b-0 last:pb-0'
                            >
                                <h4 class='font-medium text-gray-900 dark:text-white mb-2 line-clamp-2'>
                                    <a
                                        href={getBlogIndexUrl()}
                                        class='hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors'
                                    >
                                        Los mejores destinos para viajar en familia
                                    </a>
                                </h4>
                                <p class='text-sm text-gray-600 dark:text-gray-400'>10 de enero, 2024</p>
                            </article>
                            <article>
                                <h4 class='font-medium text-gray-900 dark:text-white mb-2 line-clamp-2'>
                                    <a
                                        href={getBlogIndexUrl()}
                                        class='hover:text-emerald-600 dark:hover:text-emerald-400 transition-colors'
                                    >
                                        Consejos para ahorrar en tus vacaciones
                                    </a>
                                </h4>
                                <p class='text-sm text-gray-600 dark:text-gray-400'>5 de enero, 2024</p>
                            </article>
                        </div>
                    </div>

                    <!-- Newsletter -->
                    <div class='bg-gradient-to-br from-emerald-500 to-teal-600 rounded-lg p-6 text-white'>
                        <h3 class='text-lg font-semibold mb-3'>Suscríbete al blog</h3>
                        <p class='text-emerald-100 mb-4 text-sm'>
                            Recibe los últimos artículos directamente en tu email.
                        </p>
                        <form class='space-y-3'>
                            <input
                                type='email'
                                placeholder='Tu email'
                                class='w-full px-3 py-2 rounded-lg text-gray-900 text-sm'
                            />
                            <button
                                class='w-full bg-white text-emerald-600 py-2 px-4 rounded-lg font-semibold hover:bg-gray-100 transition-colors text-sm'
                            >
                                Suscribirse
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</MainLayout>
