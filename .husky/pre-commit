#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Get staged files that match our patterns (exclude deleted files)
STAGED_CLAUDE_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '^\.claude/' || true)

# 1. Run lint-staged for formatting and linting (BLOCKING)
echo "üîç Running lint-staged..."
pnpm exec lint-staged

# 2. Validate .claude documentation changes
if [ -n "$STAGED_CLAUDE_FILES" ]; then
  echo "üîç Validating .claude documentation..."

  # Check for broken links in staged files
  for file in $STAGED_CLAUDE_FILES; do
    if [ -f "$file" ] && [ "${file##*.}" = "md" ]; then
      # Simple link validation - check if referenced files exist
      grep -oP '\]\(\K[^)]+' "$file" 2>/dev/null | while read -r link; do
        # Skip URLs and anchors
        if ! echo "$link" | grep -qE '^(https?:|#)'; then
          # Convert relative path to absolute
          link_dir=$(dirname "$file")
          link_path="$link_dir/$link"
          if [ ! -f "$link_path" ] && [ ! -d "$link_path" ]; then
            echo "‚ö†Ô∏è  Warning: Broken link in $file: $link"
          fi
        fi
      done
    fi
  done
fi

# 4. Sync TODO comments with GitHub
echo "üìù Syncing TODO comments with GitHub..."

# Capture currently staged files before sync (exclude deleted files)
STAGED_FILES_BEFORE=$(git diff --cached --name-only --diff-filter=ACMR)

if pnpm --filter=@repo/github-workflow run hook:pre-commit 2>/dev/null; then
  echo "‚úÖ TODO sync completed successfully"
  # Re-add only the files that were originally staged and still exist
  if [ -n "$STAGED_FILES_BEFORE" ]; then
    for file in $STAGED_FILES_BEFORE; do
      if [ -f "$file" ]; then
        git add "$file"
      fi
    done
  fi
else
  echo "‚ö†Ô∏è  TODO sync failed or not configured - continuing with commit"
fi

echo "‚úÖ Pre-commit checks complete"
